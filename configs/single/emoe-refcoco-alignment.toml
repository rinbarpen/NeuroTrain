# EMOE模型在RefCOCO数据集上的Region-Text对齐训练配置
# 任务：训练EMOE模型对图像区域和文本描述进行对齐

# 基础配置
output_dir = "runs"
task = "emoe_refcoco_alignment"
device = "cuda"
seed = 42
run_id = ""

# 类别配置（RefCOCO任务不需要固定类别，使用文本描述）
classes = []

# 评估指标配置
metrics = [
    "clip_accuracy",
    "image_retrieval_recall@1",
    "image_retrieval_recall@5",
    "text_retrieval_recall@1",
    "text_retrieval_recall@5",
    "image_text_similarity",
    "region_text_alignment_accuracy"
]

# EMOE模型配置
[model]
name = "EMOE_RefCOCO"
continue_checkpoint = ""
continue_ext_checkpoint = ""
pretrained = ""

[model.config]
# EMOE (EViTMoE) 配置
backbone = "vit_base_patch16_224"  # ViT backbone
vit_hidden_dim = 768  # ViT隐藏层维度
num_heads = 8  # 注意力头数
num_experts = 4  # MoE专家数量
# expert_hidden_dim = null  # 专家隐藏层维度，不设置表示使用input_dim
k = 2  # top-k专家选择
sparse = true  # 使用稀疏MoE
dropout = 0.1  # Dropout率

# 文本编码器配置（使用CLIP的文本编码器部分）
text_encoder_name = "openai/clip-vit-base-patch32"
text_encoder_dim = 512  # CLIP文本编码器输出维度

# 对齐层配置
alignment_dim = 512  # 对齐后的特征维度
alignment_method = "contrastive"  # 对齐方法：contrastive, mse, cosine
temperature = 0.07  # 对比学习温度参数

# 区域处理配置
region_crop_size = 224  # 区域裁剪尺寸
region_padding = 0.1  # 区域边界padding比例

# 模型输入配置
# input_sizes = [
#     [1, -1, 3, 224, 224],  # (B, N_OBJ, C, H, W)
#     [1, -1, 77]  # 文本token序列长度
# ]
dtypes = ["float32", "int64"]

# 图像预处理（针对区域裁剪）
[transform]
RESIZE = [224, 224]
# HFLIP = [0.5]  # 可选：区域水平翻转
# ROTATION = [5.0]  # 可选：小角度旋转
PIL_TO_TENSOR = []
CONVERT_IMAGE_DTYPE = ["float32"]
NORMALIZE = [true]  # 可选：归一化

# 数据集配置
[dataset]
name = "coco2017_alignment"
root_dir = "data/coco2017"

# 数据加载配置
[dataloader]
shuffle = true
num_workers = 8
pin_memory = true
drop_last = true

# 训练配置
[train]
batch_size = 1  # 由于需要处理多个区域，batch_size较小
epoch = 100
save_period = 10
save_recovery_period = 1
grad_accumulation_steps = 8  # 梯度累积
grad_clip_norm = 1.0  # 梯度裁剪

# 混合精度训练
use_amp = true
amp_dtype = "float16"

[train.optimizer]
type = "AdamW"
learning_rate = 0.0001
weight_decay = 0.01
betas = [0.9, 0.999]
eps = 1e-8

[train.lr_scheduler]
type = "cosine_annealing"
T_max = 100
eta_min = 0.000001
warmup_epochs = 10
warmup_start_lr = 0.000001

# [train.early_stopping]
# patience = 15
# monitor = "valid_region_text_alignment_accuracy"
# mode = "max"

# 损失函数配置
# [[criterion]]
# # 对比学习损失
# type = "contrastive_loss"
# weight = 1.0
# # 是否对称损失（text2image + image2text）
# config = { temperature = 0.07, symmetric = true }

# 可选：添加辅助损失
# [[criterion]]
# type = "mse_loss"  # 辅助MSE损失
# weight = 0.1
# config = {}

# 验证配置
[valid]
batch_size = 1
period = 1
save_best = true
compute_retrieval_metrics = true
compute_alignment_metrics = true

# 测试配置
[test]
batch_size = 1
compute_all_metrics = true
save_predictions = true
save_features = true
save_similarities = true

# 预测配置
[predict]
batch_size = 1
save_features = true
save_similarities = true
save_attention_maps = true  # 保存注意力图

# 私有配置（日志、调试等）
[private]
mode = 1

[private.log]
verbose = true
debug = false
log_format = "%(asctime)s %(levelname)s | %(name)s | %(message)s"
log_file_format = '%Y-%m-%d %H_%M_%S'

[private.wandb]
enabled = false
project = "emoe-refcoco-alignment"
entity = "neurotrain-lab"
tags = ["emoe", "refcoco", "region-text-alignment", "multimodal"]
notes = "EMOE model training on RefCOCO dataset for region-text alignment"

[private.checkpoint]
save_optimizer = true
save_scheduler = true
save_best_only = false
monitor_metric = "valid_image_text_similarity"

[private.visualization]
plot_training_curves = true
save_attention_maps = true
save_similarity_matrices = true
plot_alignment_examples = true  # 绘制对齐示例
plot_retrieval_examples = true  # 绘制检索示例

[private.debug]
print_model_structure = false
save_intermediate_features = false
check_gradients = false

